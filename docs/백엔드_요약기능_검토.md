# 백엔드 요약 기능 검토 (중복 URL 체크 이후)

## 검토 범위
- 북마크 생성 → 요약 태스크 제출 → DB 요약 컬럼 갱신 흐름
- 중복 URL 체크 추가가 요약 로직에 미치는 영향

---

## 1. 북마크 생성 흐름 (bookmarks.py)

- **중복 체크**: `get_by_url(db, url=url_str)` → 409 시 예외, 이후 로직 미실행 (요약 불필요).
- **정상 시**: 스크래핑 → `Bookmark` 생성 → `db.commit()` → `db.refresh(db_bookmark)` → **`submit_summary_task(str(db_bookmark.id), scraped_data['content'])`** 호출.
- **결론**: 중복 체크는 생성 직전에만 있으며, 생성 후 요약 태스크 제출은 그대로 호출됨. **연관 없음.**

---

## 2. 요약 태스크 (summary_tasks.py) – 수정한 부분

### 원인으로 보인 문제
- `update_bookmark_summary(bookmark_id: str, content: str)` 에서 **`Bookmark.id == bookmark_id`** 로 조회.
- **`Bookmark.id`** 는 **UUID(as_uuid=True)** 타입이고, **`bookmark_id`** 는 **문자열**로 전달됨.
- DB/드라이버에 따라 **문자열과 UUID 컬럼 비교 시 행을 찾지 못할 수 있음** → `bookmark`가 `None` → 요약 갱신을 하지 않아 DB 요약 컬럼이 비어 있음.

### 적용한 수정 사항
1. **bookmark_id → UUID 변환**  
   - `bookmark_id`를 `uuid.UUID(bookmark_id)` 로 변환한 뒤, **`Bookmark.id == bid`** 로 조회하도록 변경.
2. **조회 실패 시 로깅**  
   - 북마크를 찾지 못하면 `logger.warning("요약 업데이트할 북마크를 찾을 수 없음: id=...")` 로그 출력.
3. **예외 시 로깅**  
   - `logger.exception("상세:")` 로 스택 트레이스 기록.
4. **요약 실패 시 fallback**  
   - `generate_summary(content)` 가 빈 문자열을 반환하면, DB에는 **`"요약 생성에 실패했습니다."`** 로 저장하도록 처리.
5. **세션 정리**  
   - `db = None` 초기화 후, `finally`에서 `if db: db.close()` 로 세션 종료 보장.

---

## 3. 요약 생성 (scraping_service.generate_summary)

- 예외 시 빈 문자열 `""` 반환.  
- 위 fallback에 의해 DB에는 "요약 생성에 실패했습니다." 가 들어가며, 요약 컬럼이 비는 상황은 방지됨.

---

## 4. “원래 정상 동작하던 코드”인데 왜 문제가 생겼나?

- 요약 태스크는 **중복 URL 체크를 넣을 때 수정한 적이 없습니다.**  
  즉, **예전부터** `bookmark_id`는 문자열로 넘어오고, `Bookmark.id == bookmark_id`(문자열 vs UUID 컬럼)로 조회하는 코드였습니다.

- 그런데 **DB/드라이버/버전에 따라** “문자열과 UUID 컬럼 비교” 결과가 달라질 수 있습니다.
  - **예전 환경**에서는 PostgreSQL이나 SQLAlchemy/psycopg2가 쿼리 시 문자열을 UUID로 암묵 변환해서 **우연히 행을 찾아주었을** 수 있습니다.
  - **지금 환경**이 다르거나(DB/라이브러리 업그레이드, 다른 DB 클라이언트 등), 같은 코드라도 **드라이버가 문자열을 UUID로 넣어주지 않으면** `WHERE id = '...'` 가 기대대로 동작하지 않아 **행을 못 찾고** `bookmark`가 `None`이 됩니다.
  - 그 결과, 요약 갱신을 하지 않아 **DB 요약 컬럼이 비는 현상**이 나타납니다.

- 정리하면:
  - **동작이 “환경에 의존”하는 잠재적 버그**가 있었고,
  - 환경이 바뀌거나, 테스트/배포 환경이 달라지면서 **그때부터** 요약이 안 되는 것처럼 보인 것입니다.
  - 그래서 “원래는 됐다”고 느끼시는 것이고, **중복 URL 체크 추가가 직접 원인은 아닙니다.**

- **해결**: `bookmark_id`를 **명시적으로 `uuid.UUID(bookmark_id)`로 변환**한 뒤 조회하면, DB/드라이버 버전과 관계없이 동일하게 동작합니다.  
  이번에 그렇게 수정했기 때문에, 앞으로는 환경이 바뀌어도 요약이 동일하게 동작할 가능성이 높습니다.

---

## 5. 요약

- **중복 URL 체크** 자체는 요약 로직을 건드리지 않음.
- **DB에 요약이 채워지지 않던 현상**은, 요약 태스크에서 **문자열 `bookmark_id`로 UUID 컬럼을 조회**하면서 행을 찾지 못했을 가능성이 큼. (환경에 따라 “원래는 됐다”가 가능한 **잠재 버그**.)
- **`summary_tasks.update_bookmark_summary`** 에서 **bookmark_id를 UUID로 변환해 조회**하고, 조회 실패·예외·요약 실패 시 로깅과 fallback을 넣었으므로, 동일 환경에서 재현 시 로그로 원인 확인이 가능하고, 요약 컬럼이 비는 경우는 줄어듦.
